<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ModelRelay</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/favicon.svg">
  <style>
    :root {
      --bg: #fdfcfb;
      --card: #ffffff;
      --border: #eceae8;
      --text: #1a1918;
      --text-muted: #8c8985;
      --accent: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }

    body {
      margin: 0;
      font-family: "Geist", "Inter", sans-serif;
      background-color: var(--bg);
      color: var(--text);
      padding-bottom: 100px;
    }

    /* Layout */
    .container {
      max-width: 1400px;
      margin: 48px auto;
      padding: 0 24px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .dashboard-eyebrow {
      margin: 0;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      font-weight: 700;
    }

    .dashboard-heading {
      margin: 8px 0 0;
      font-size: clamp(1.45rem, 2.2vw, 2rem);
      letter-spacing: -0.03em;
    }

    .dashboard-subtitle {
      margin: 8px 0 0;
      color: var(--text-muted);
      font-size: 0.9rem;
      max-width: 58ch;
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
      margin-bottom: 40px;
    }

    .kpi-card {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 18px 20px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 102px;
      position: relative;
      overflow: hidden;
    }

    /* SVG Animations */
    .kpi-bg-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
      opacity: 0.6;
    }

    .kpi-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .star-dim {
      fill: var(--text-muted);
      opacity: 0.15;
      transition: all 1.5s ease-in-out;
    }

    .star-bright {
      fill: var(--accent);
      animation: twinkle 3s infinite alternate;
      transition: all 1.5s ease-in-out;
    }

    .constellation-line {
      stroke: var(--accent);
      stroke-width: 0.5;
      opacity: 0.3;
      transition: all 1.5s ease-in-out;
    }

    .constellation-line-hidden {
      stroke: var(--accent);
      stroke-width: 0.5;
      opacity: 0;
      transition: all 1.5s ease-in-out;
    }

    .net-node-dim {
      fill: var(--text-muted);
      opacity: 0.15;
      transition: all 1.5s ease-in-out;
    }

    .net-node-bright {
      fill: var(--success);
      filter: drop-shadow(0 0 2px var(--success));
      animation: pulse-node 4s infinite alternate;
      transition: all 1.5s ease-in-out;
    }

    .net-link {
      stroke: var(--text-muted);
      stroke-width: 0.5;
      opacity: 0.1;
      transition: all 1.5s ease-in-out;
    }

    .net-link-active {
      stroke: var(--success);
      stroke-width: 1;
      opacity: 0.6;
      animation: dash 30s linear infinite;
      stroke-dasharray: 4;
      transition: all 1.5s ease-in-out;
    }

    .net-hub {
      fill: var(--text);
      filter: drop-shadow(0 0 4px var(--text));
    }

    .current-core {
      fill: none;
      stroke: var(--accent);
      stroke-width: 1;
      opacity: 0.2;
      transform-origin: center;
      animation: spin-slow 30s linear infinite;
      transition: opacity 1.5s ease-in-out;
    }

    .current-pulse {
      fill: var(--accent);
      opacity: 0.1;
      transform-origin: center;
      animation: heart-beat 4s ease-in-out infinite alternate;
      transition: opacity 1.5s ease-in-out;
    }

    @keyframes twinkle {
      0% {
        opacity: 0.4;
      }

      100% {
        opacity: 1;
        filter: drop-shadow(0 0 2px var(--accent));
      }
    }

    @keyframes pulse-node {
      0% {
        opacity: 0.5;
        transform: scale(0.9);
      }

      100% {
        opacity: 1;
        transform: scale(1.1);
      }
    }

    @keyframes dash {
      to {
        stroke-dashoffset: -100;
      }
    }

    @keyframes spin-slow {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes heart-beat {
      0% {
        transform: scale(0.8);
        opacity: 0.05;
      }

      100% {
        transform: scale(1.2);
        opacity: 0.25;
      }
    }

    .kpi-label {
      font-size: 0.8125rem;
      color: var(--text-muted);
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .kpi-value {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .signal-icon {
      width: 12px;
      height: 12px;
      fill: var(--accent);
      opacity: 0.3;
    }

    .kpi-card:hover .signal-icon {
      animation: signal-ping 1s ease-out forwards;
    }

    @keyframes signal-ping {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }

      100% {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 0.75rem 0;
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.875rem;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* Views */
    #settings-view {
      display: none;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
    }

    #setup-view {
      display: none;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
    }

    .setup-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 20px;
    }

    .setup-card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      background: #faf9f8;
    }

    .setup-card h3 {
      margin: 0 0 10px;
      font-size: 1rem;
    }

    .setup-method {
      margin-top: 14px;
    }

    .setup-method-title {
      margin: 0 0 8px;
      font-size: 0.82rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 700;
    }

    .setup-steps {
      margin: 0;
      padding-left: 18px;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .setup-snippet {
      margin: 10px 0 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 0.78rem;
      line-height: 1.45;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      white-space: pre;
      overflow-x: auto;
    }

    @media (max-width: 920px) {
      .setup-grid {
        grid-template-columns: 1fr;
      }

      .dashboard-header {
        align-items: flex-start;
      }
    }

    @media (max-width: 640px) {
      .container {
        margin: 28px auto;
        padding: 0 14px;
      }

      .kpi-grid {
        gap: 12px;
      }

      .kpi-card {
        min-height: 94px;
        padding: 14px 16px;
      }
    }

    /* Table Card */
    .table-container {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
    }

    .table-title {
      font-weight: 600;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .search-bar {
      flex: 1;
      position: relative;
      max-width: 400px;
    }

    .search-input {
      width: 100%;
      background: #f3f2f1;
      border: 1px solid transparent;
      padding: 8px 16px 8px 36px;
      border-radius: 8px;
      font-size: 0.875rem;
      outline: none;
      transition: all 0.2s;
    }

    .search-input:focus {
      background: white;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th {
      text-align: left;
      padding: 12px 24px;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 600;
      background: #faf9f8;
    }

    th.sortable {
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    /* Filter Bar */
    .filter-bar {
      display: none;
      gap: 16px;
      padding: 12px 24px;
      background: #faf9f8;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .filter-bar.visible {
      display: flex;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-right: 16px;
      border-right: 1px solid var(--border);
    }

    .filter-group:last-child {
      border-right: none;
      padding-right: 0;
    }

    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      min-width: 120px;
    }

    .filter-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .filter-shortcut {
      font-size: 0.65rem;
      color: var(--accent);
      cursor: pointer;
      user-select: none;
    }

    .filter-shortcut:hover {
      text-decoration: underline;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 180px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .checkbox-group::-webkit-scrollbar {
      width: 4px;
    }

    .checkbox-group::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .cb-label {
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text);
      cursor: pointer;
      white-space: nowrap;
    }

    .cb-label input {
      margin: 0;
      cursor: pointer;
    }

    th.sortable:hover {
      color: var(--text);
    }

    th.sort-active {
      color: var(--accent);
    }

    .sort-arrow {
      display: inline-block;
      margin-left: 4px;
      opacity: 0.4;
      font-style: normal;
      font-size: 0.6rem;
      vertical-align: middle;
    }

    th.sort-active .sort-arrow {
      opacity: 1;
    }

    td {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      font-size: 0.875rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* Custom Elements */
    .tier-badge {
      font-weight: 700;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 6px;
      background: #f3f2f1;
      border: 1px solid transparent;
    }

    .tier-S\+ {
      background: #ecfdf5;
      color: #065f46;
      border-color: #a7f3d0;
    }

    .tier-S {
      background: #f0fdf4;
      color: #166534;
      border-color: #bbf7d0;
    }

    .tier-A\+ {
      background: #eff6ff;
      color: #1e40af;
      border-color: #bfdbfe;
    }

    .tier-A {
      background: #f0f9ff;
      color: #075985;
      border-color: #bae6fd;
    }

    .tier-B {
      background: #fffbeb;
      color: #92400e;
      border-color: #fef3c7;
    }

    .tier-C {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fee2e2;
    }

    .progress-pill {
      width: 80px;
      height: 6px;
      background: #f3f2f1;
      border-radius: 999px;
      position: relative;
      overflow: hidden;
    }

    .progress-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      background: var(--success);
      border-radius: 999px;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ping-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 6px;
      position: relative;
    }

    .ping-dot.anim-fast {
      background: var(--success);
    }

    .ping-dot.anim-medium {
      background: var(--warning);
    }

    .ping-dot.anim-slow {
      background: var(--error);
    }

    .ping-dot.active::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 50%;
      background: inherit;
      animation: ping-pulse var(--speed, 3s) ease-out infinite;
    }

    @keyframes ping-pulse {
      0% {
        transform: scale(1);
        opacity: 0.45;
      }

      100% {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    .expand-btn {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .expand-btn:hover {
      background: #f3f2f1;
    }

    /* Switch Component */
    .switch {
      position: relative;
      display: inline-block;
      width: 36px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e7eb;
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--accent);
    }

    input:focus+.slider {
      box-shadow: 0 0 1px var(--accent);
    }

    input:checked+.slider:before {
      transform: translateX(16px);
    }

    .text-right {
      text-align: right;
    }

    /* Settings UI */
    .provider-section {
      border-bottom: 1px solid var(--border);
      padding-bottom: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .provider-section:last-child {
      border-bottom: none;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group input[type="password"] {
      width: 100%;
      padding: 0.75rem;
      background: #f3f2f1;
      border: 1px solid transparent;
      border-radius: 8px;
      color: var(--text);
      box-sizing: border-box;
      outline: none;
    }

    .form-group input[type="password"]:focus {
      background: white;
      border-color: var(--accent);
    }

    .autoupdate-panel {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      background: linear-gradient(135deg, #ffffff 0%, #fbfaf8 100%);
      box-shadow: 0 8px 22px rgba(26, 25, 24, 0.06);
      overflow: hidden;
    }

    .autoupdate-panel::after {
      content: "";
      position: absolute;
      inset: auto -35% -60% auto;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: radial-gradient(circle at center, rgba(140, 137, 133, 0.16), rgba(140, 137, 133, 0));
      pointer-events: none;
    }

    .autoupdate-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 14px;
      position: relative;
      z-index: 1;
    }

    .autoupdate-title {
      margin: 0;
      font-size: 1.02rem;
      letter-spacing: -0.01em;
    }

    .autoupdate-subtitle {
      margin-top: 4px;
      color: var(--text-muted);
      font-size: 0.8rem;
      max-width: 62ch;
      line-height: 1.45;
    }

    .autoupdate-status-pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.74rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .autoupdate-status-pill.on {
      color: #065f46;
      background: #ecfdf5;
      border-color: #a7f3d0;
    }

    .autoupdate-status-pill.off {
      color: #334155;
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .autoupdate-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 14px;
      position: relative;
      z-index: 1;
    }

    .autoupdate-toggle-label,
    .autoupdate-interval-label {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 0.84rem;
    }

    .autoupdate-toggle-label {
      cursor: pointer;
    }

    .autoupdate-interval-label input {
      width: 92px;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      background: white;
      color: var(--text);
      box-sizing: border-box;
      outline: none;
    }

    .autoupdate-interval-label input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    }

    .autoupdate-save-status {
      font-size: 0.78rem;
      color: var(--text-muted);
      min-height: 1em;
    }

    .autoupdate-save-status.success {
      color: #047857;
    }

    .autoupdate-save-status.error {
      color: #b91c1c;
    }

    .autoupdate-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .autoupdate-stat {
      background: rgba(255, 255, 255, 0.82);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px 10px;
      min-height: 54px;
    }

    .autoupdate-stat-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #64748b;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .autoupdate-stat-value {
      font-size: 0.82rem;
      color: var(--text);
      line-height: 1.35;
      word-break: break-word;
      font-weight: 600;
    }

    .autoupdate-stat-value.error {
      color: #b91c1c;
      font-weight: 700;
    }

    /* Drawer/Slide-over */
    #drawer {
      position: fixed;
      right: -100%;
      top: 0;
      bottom: 0;
      width: 450px;
      background: var(--card);
      border-left: 1px solid var(--border);
      box-shadow: -20px 0 60px rgba(0, 0, 0, 0.1);
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      padding: 40px;
      display: flex;
      flex-direction: column;
    }

    #drawer.open {
      right: 0;
    }

    .drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(2px);
      z-index: 999;
      display: none;
    }

    .drawer-overlay.active {
      display: block;
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.875rem;
    }

    /* Pin Model */
    .pin-badge {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1e40af;
      border: 1px solid #bfdbfe;
      white-space: nowrap;
    }

    /* Hover pin icon on table rows ‚Äî always sized to prevent row height shifts */
    .pin-row-btn {
      visibility: hidden;
      cursor: pointer;
      font-size: 0.75rem;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      opacity: 0.5;
      transition: opacity 0.15s, background 0.15s;
      user-select: none;
    }

    .pin-row-btn:hover {
      opacity: 1;
      background: #f3f2f1;
    }

    .pin-row-btn.pinned,
    tr:hover .pin-row-btn {
      visibility: visible;
    }

    .pin-row-btn.pinned {
      opacity: 1;
    }

    /* Collapsible log cards */
    .log-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
      overflow: hidden;
    }

    .log-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      user-select: none;
      gap: 12px;
    }

    .log-card-header:hover {
      background: rgba(0, 0, 0, 0.018);
    }

    .log-chevron {
      font-size: 0.6rem;
      color: var(--text-muted);
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .log-card.expanded .log-chevron {
      transform: rotate(90deg);
    }

    .log-card-body {
      display: none;
      padding: 0 16px 16px;
      border-top: 1px solid var(--border);
    }

    .log-card.expanded .log-card-body {
      display: block;
    }

    .logs-mode-toggle {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 9px;
      overflow: hidden;
      background: #fff;
    }

    .logs-mode-btn {
      border: 0;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.78rem;
      font-weight: 600;
      padding: 8px 12px;
      cursor: pointer;
    }

    .logs-mode-btn.active {
      background: #f3f4f6;
      color: var(--text);
    }
  </style>
</head>

<body>
  <div class="drawer-overlay" id="overlay" onclick="closeDrawer()"></div>

  <div class="container">
    <div class="dashboard-header">
      <div>
        <p class="dashboard-eyebrow">Router Control Center</p>
        <h1 class="dashboard-heading">Dashboard</h1>
        <p class="dashboard-subtitle">Live model telemetry, provider health, and routing controls in one place.
        </p>
        <p style="margin: 8px 0 0; color: var(--text-muted); font-size: 0.78rem; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <span>Version <span id="dashboard-version">Loading...</span></span>
          <span id="update-pill" style="display:none; background:#fffbeb; color:#92400e; border:1px solid #fcd34d; border-radius:999px; padding:2px 9px; font-size:0.68rem; font-weight:700; letter-spacing:0.03em; text-transform:uppercase;">Update Available</span>
        </p>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="kpi-card">
        <svg class="kpi-bg-svg" id="bg-current-svg" preserveAspectRatio="xMidYMid slice"></svg>
        <div class="kpi-content">
          <div class="kpi-label">
            Current Model
            <svg class="signal-icon" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" />
            </svg>
          </div>
          <div class="kpi-value" id="kpi-best">Calculating...</div>
          <div style="margin-top:6px; min-height:20px;">
            <span class="pin-badge" id="pin-badge" style="display:none; cursor:pointer;" onclick="pinModel('')"
              title="Click to unpin">üìå Pinned √ó</span>
          </div>
        </div>
      </div>
      <div class="kpi-card">
        <svg class="kpi-bg-svg" id="bg-models-svg" preserveAspectRatio="xMidYMid slice"></svg>
        <div class="kpi-content">
          <div class="kpi-label">
            Models Online
            <svg class="signal-icon" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" />
            </svg>
          </div>
          <div class="kpi-value" id="kpi-active">0</div>
        </div>
      </div>
      <div class="kpi-card">
        <svg class="kpi-bg-svg" id="bg-providers-svg" preserveAspectRatio="xMidYMid slice"></svg>
        <div class="kpi-content">
          <div class="kpi-label">
            Providers Online
            <svg class="signal-icon" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" />
            </svg>
          </div>
          <div class="kpi-value" id="kpi-providers">0</div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab-models" onclick="switchTab('models')">Live Telemetry</div>
      <div class="tab" id="tab-logs" onclick="switchTab('logs')">Request Logs</div>
      <div class="tab" id="tab-settings" onclick="switchTab('settings')">Settings</div>
      <div class="tab" id="tab-setup" onclick="switchTab('setup')">Setup Instructions</div>
    </div>

    <div id="models-view">
      <div class="table-container">
        <div class="table-header">
          <div class="table-title">Models</div>
          <div class="search-bar">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.3-4.3" />
            </svg>
            <input type="text" class="search-input" id="search-input"
              placeholder="Search models, providers, or tiers..." oninput="handleSearch()">
          </div>
          <div style="display:flex; align-items:center; gap:20px; flex-shrink: 0;">
            <button onclick="toggleFilterBar()"
              style="display:flex; align-items:center; gap:6px; border:1px solid var(--border); background:white; cursor:pointer; font-size:0.8rem; color:var(--text); padding:6px 12px; border-radius:6px; transition:all 0.15s; font-weight:500;"
              onmouseover="this.style.background='#f3f2f1'" onmouseout="this.style.background='white'">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
              </svg>
              Filters
            </button>
            <div style="display:flex; align-items:center; gap:10px;">
              <div id="hover-pause-badge"
                style="display:none; background:var(--warning); color:#92400e; padding:4px 8px; border-radius:6px; font-size:0.7rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; align-items:center; gap:4px;">
                ‚è∏ Paused on hover</div>
              <span style="font-size:0.8rem; color:var(--text-muted); cursor:pointer; user-select:none;"
                onclick="document.getElementById('live-sort-toggle').click()">Live Sort</span>
              <label class="switch">
                <input type="checkbox" id="live-sort-toggle" checked onchange="render(true)">
                <span class="slider"></span>
              </label>
            </div>
            <button id="sort-reset-btn" onclick="resetSort()"
              style="display:none; border:none; background:none; cursor:pointer; font-size:0.8rem; color:var(--text-muted); padding:4px 8px; border-radius:6px; white-space:nowrap; transition:all 0.15s;"
              onmouseover="this.style.background='#f3f2f1';this.style.color='var(--text)'"
              onmouseout="this.style.background='none';this.style.color='var(--text-muted)'">&#x2715; Reset
              sort</button>
          </div>
        </div>

        <div class="filter-bar">


          <div class="filter-group">
            <div class="filter-header">
              <span class="filter-label">Provider</span>
              <span class="filter-shortcut" onclick="toggleAll('filter-provider-group')">(All/None)</span>
            </div>
            <div class="checkbox-group" id="filter-provider-group">
              <!-- Populated dynamically -->
            </div>
          </div>

          <div class="filter-group">
            <div class="filter-header">
              <span class="filter-label">Ping</span>
              <span class="filter-shortcut" onclick="toggleAll('filter-ping-group')">(All/None)</span>
            </div>
            <div class="checkbox-group" id="filter-ping-group">
              <label class="cb-label"><input type="checkbox" value="fast" checked onchange="render(true)"> Fast
                (&lt;400ms)</label>
              <label class="cb-label"><input type="checkbox" value="medium" checked onchange="render(true)"> Medium
                (400-1199ms)</label>
              <label class="cb-label"><input type="checkbox" value="slow" checked onchange="render(true)"> Slow
                (&ge;1200ms)</label>
            </div>
          </div>

          <div class="filter-group">
            <div class="filter-header">
              <span class="filter-label">Availability</span>
              <span class="filter-shortcut" onclick="toggleAll('filter-avail-group')">(All/None)</span>
            </div>
            <div class="checkbox-group" id="filter-avail-group">
              <label class="cb-label"><input type="checkbox" value="excellent" checked onchange="render(true)">
                Excellent (&ge;95%)</label>
              <label class="cb-label"><input type="checkbox" value="good" checked onchange="render(true)"> Good
                (85-94%)</label>
              <label class="cb-label"><input type="checkbox" value="poor" checked onchange="render(true)"> Poor
                (&lt;85%)</label>
            </div>
          </div>

          <div class="filter-group">
            <div class="filter-header">
              <span class="filter-label">Status</span>
              <span class="filter-shortcut" onclick="toggleAll('filter-status-group')">(All/None)</span>
            </div>
            <div class="checkbox-group" id="filter-status-group">
              <label class="cb-label"><input type="checkbox" value="up" checked onchange="render(true)"> Up</label>
              <label class="cb-label"><input type="checkbox" value="down" checked onchange="render(true)"> Down</label>
              <label class="cb-label"><input type="checkbox" value="disabled" checked onchange="render(true)">
                Disabled</label>
            </div>
          </div>
        </div>

        <table onmouseenter="isTableHovered=true; document.getElementById('hover-pause-badge').style.display='flex';"
          onmouseleave="isTableHovered=false; document.getElementById('hover-pause-badge').style.display='none';">
          <thead>
            <tr>
              <th width="40"></th>
              <th class="sortable" onclick="setSort('model')" id="th-model">Model <i class="sort-arrow"
                  id="arrow-model">‚Üï</i></th>
              <th class="sortable" width="80" onclick="setSort('qos')" id="th-qos">QoS <i class="sort-arrow"
                  id="arrow-qos">‚Üï</i></th>
              <th class="sortable" width="80" onclick="setSort('intell')" id="th-intell">SWE% <i class="sort-arrow"
                  id="arrow-intell">‚Üï</i></th>
              <th class="sortable text-right" width="120" onclick="setSort('ping')" id="th-ping">Ping <i
                  class="sort-arrow" id="arrow-ping">‚Üï</i></th>
              <th class="sortable text-right" width="150" onclick="setSort('availability')" id="th-availability">
                Availability <i class="sort-arrow" id="arrow-availability">‚Üï</i></th>
              <th class="sortable" width="100" onclick="setSort('status')" id="th-status">Status <i class="sort-arrow"
                  id="arrow-status">‚Üï</i></th>
            </tr>
          </thead>
          <tbody id="table-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="settings-view" style="display: none;">
      <h2 style="margin-top: 0; font-size: 1.25rem;">Settings</h2>
      <p style="color: var(--text-muted); margin-bottom: 1.25rem; font-size: 0.875rem;">Manage router update behavior and provider credentials.</p>
      <div id="autoupdate-container" class="provider-section">
        <!-- Auto-update settings generated here -->
      </div>
      <h3 style="margin: 0 0 0.25rem; font-size: 1rem;">Providers</h3>
      <p style="color: var(--text-muted); margin: 0 0 1.25rem; font-size: 0.84rem;">Configure API keys to enable models from different providers.</p>
      <div id="providers-container">
        <!-- Settings generated here -->
      </div>
    </div>

    <div id="logs-view" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
          <h2 style="margin: 0; font-size: 1.25rem;">Recent Requests</h2>
          <p style="color: var(--text-muted); margin: 4px 0 0; font-size: 0.875rem;">Last 50 requests proxied through
            the router.</p>
        </div>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <div class="logs-mode-toggle" role="tablist" aria-label="Logs view mode">
            <button id="logs-mode-cards" class="logs-mode-btn" onclick="setLogsViewMode('cards')" role="tab"
              aria-selected="false">Request Cards</button>
            <button id="logs-mode-history" class="logs-mode-btn active" onclick="setLogsViewMode('history')" role="tab"
              aria-selected="true">Message History</button>
          </div>
          <button onclick="loadLogs()" class="btn"
            style="background: white; color: var(--text); border: 1px solid var(--border);">Refresh Logs</button>
        </div>
      </div>
      <div id="logs-container" style="display: flex; flex-direction: column; gap: 16px;">
        <!-- Logs generated here -->
      </div>
    </div>

    <div id="setup-view" style="display: none;">
      <h2 style="margin-top: 0; font-size: 1.25rem;">Setup Instructions</h2>
      <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.875rem;">Configure OpenClaw and OpenCode
        (Opencode) to use this router.</p>

      <div class="setup-grid">
        <div class="setup-card">
          <h3>OpenClaw</h3>

          <div class="setup-method">
            <p class="setup-method-title">Automatic</p>
            <ol class="setup-steps">
              <li>Run <code>modelrelay onboard</code>.</li>
              <li>When asked <code>Auto-configure OpenClaw now? [Y/n]</code>, answer <code>Y</code>.</li>
              <li>Start the router with <code>modelrelay</code>.</li>
            </ol>
          </div>

          <div class="setup-method">
            <p class="setup-method-title">Manual</p>
            <div style="font-size:0.83rem; color:var(--text-muted);">Merge this into
              <code>~/.openclaw/openclaw.json</code>:
            </div>
            <pre class="setup-snippet">{
  "models": {
    "providers": {
      "modelrelay": {
        "baseUrl": "http://127.0.0.1:7352/v1",
        "api": "openai-completions"
      }
    }
  },
  "agents": {
    "defaults": {
      "model": {
        "primary": "modelrelay/auto-fastest"
      },
      "models": {
        "modelrelay/auto-fastest": {}
      }
    }
  }
}</pre>
          </div>
        </div>

        <div class="setup-card">
          <h3>OpenCode (Opencode)</h3>

          <div class="setup-method">
            <p class="setup-method-title">Automatic</p>
            <ol class="setup-steps">
              <li>Run <code>modelrelay onboard</code>.</li>
              <li>When asked <code>Auto-configure OpenCode now? [Y/n]</code>, answer <code>Y</code>.</li>
              <li>Start the router with <code>modelrelay</code>.</li>
            </ol>
          </div>

          <div class="setup-method">
            <p class="setup-method-title">Manual</p>
            <div style="font-size:0.83rem; color:var(--text-muted);">Put this in
              <code>~/.config/opencode/opencode.json</code>:
            </div>
            <pre class="setup-snippet">{
  "$schema": "https://opencode.ai/config.json",
  "provider": {
    "router": {
      "npm": "@ai-sdk/openai-compatible",
      "name": "modelrelay",
      "options": {
        "baseURL": "http://127.0.0.1:7352/v1",
        "apiKey": "dummy-key"
      },
      "models": {
        "auto-fastest": {
          "name": "Auto Fastest"
        }
      }
    }
  },
  "model": "router/auto-fastest"
}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="drawer">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
      <h2 id="drawer-title" style="margin: 0; font-size: 1.25rem;">Model Details</h2>
      <button onclick="closeDrawer()"
        style="border: none; background: #f3f2f1; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">&times;</button>
    </div>
    <div id="drawer-content"></div>
  </div>

  <script>
    let allModels = [];
    let searchTerm = '';
    // null = default multi-sort; otherwise { col: string, dir: 'asc'|'desc' }
    let sortState = null;
    let openDrawerModelId = null;
    let currentRenderedOrder = [];
    let activePinnedModelId = null; // tracks the currently pinned model server-side
    let isTableHovered = false;
    let metaLoaded = false;
    let logsViewMode = 'history';
    const PROVIDER_ERROR_MAX_AGE_MS = 120 * 60_000;
    let qwenOauthSessionId = null;
    let qwenOauthPollTimer = null;



    async function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');

      document.getElementById('models-view').style.display = tab === 'models' ? 'block' : 'none';
      document.getElementById('logs-view').style.display = tab === 'logs' ? 'block' : 'none';
      document.getElementById('settings-view').style.display = tab === 'settings' ? 'block' : 'none';
      document.getElementById('setup-view').style.display = tab === 'setup' ? 'block' : 'none';

      if (tab === 'settings') {
        loadSettings();
      } else if (tab === 'logs') {
        loadLogs();
      }
    }

    async function fetchData() {
      try {
        if (!metaLoaded) {
          loadMeta();
        }
        const res = await fetch('/api/models');
        const data = await res.json();

        // Calculate QoS for each model
        const providers = new Set();
        allModels = data.models.map(m => {
          providers.add(m.providerKey);

          let isRateLimited = false;
          let rateLimitResetMs = 0;
          if (m.rateLimit) {
            const now = Date.now();
            // Flag as rate-limited when the actual proxied prompt got a 429
            if (m.rateLimit.wasRateLimited === true) {
              isRateLimited = true;
              rateLimitResetMs = Math.max(
                m.rateLimit.resetRequestsAt ? Math.max(0, m.rateLimit.resetRequestsAt - now) : 0,
                m.rateLimit.resetTokensAt ? Math.max(0, m.rateLimit.resetTokensAt - now) : 0
              );
            }
            // Also flag when credits are exhausted (e.g. OpenRouter free tier).
            // Credits are an account-level balance (not a sliding window), so
            // creditRemaining <= 0 is an authoritative signal.
            if (m.rateLimit.creditLimit != null && m.rateLimit.creditRemaining != null && m.rateLimit.creditRemaining <= 0) {
              isRateLimited = true;
              if (m.rateLimit.creditResetAt && m.rateLimit.creditResetAt > now) {
                rateLimitResetMs = Math.max(rateLimitResetMs, m.rateLimit.creditResetAt - now);
              }
            }
          }

          return { ...m, qos: m.qos || 0, isRateLimited };
        });

        // Populate Provider Checkboxes
        const providerGroup = document.getElementById('filter-provider-group');
        if (providerGroup.children.length === 0) {
          const provHtml = [];
          Array.from(providers).sort().forEach(p => {
            provHtml.push(`<label class="cb-label"><input type="checkbox" value="${p}" checked onchange="render(true)"> ${p}</label>`);
          });
          providerGroup.innerHTML = provHtml.join('');
        }

        render(); // triggers automatic (non-user) layout pass
        updateKPIs(allModels, data.best, data.pinnedModelId);
        if (openDrawerModelId) {
          const m = allModels.find(x => x.modelId === openDrawerModelId);
          if (m) updateDrawerContent(m);
        }
        // Live-update logs if that tab is currently active
        if (document.getElementById('logs-view').style.display !== 'none') {
          loadLogs();
        }
        // Live-update providers if that tab is currently active
        if (document.getElementById('settings-view').style.display !== 'none') {
          loadSettings();
        }
      } catch (e) {
        console.error('Fetch error:', e);
      }
    }

    async function loadMeta() {
      try {
        const res = await fetch('/api/meta');
        if (!res.ok) throw new Error('meta fetch failed');
        const meta = await res.json();
        if (!meta || !meta.version || meta.version === 'unknown') throw new Error('meta missing version');
        const versionEl = document.getElementById('dashboard-version');
        const pillEl = document.getElementById('update-pill');
        versionEl.textContent = `v${meta.version}`;
        if (meta.autoUpdate) {
          const interval = Number(meta.autoUpdate.intervalHours) > 0 ? Number(meta.autoUpdate.intervalHours) : 24;
          const state = meta.autoUpdate.enabled === false ? 'off' : 'on';
          versionEl.title = `Auto-update: ${state} (${interval}h)`;
        }

        if (pillEl) {
          if (meta.updateAvailable && meta.latestVersion) {
            pillEl.textContent = `Update Available: v${meta.latestVersion}`;
            pillEl.style.display = 'inline-flex';
            pillEl.title = `Current: v${meta.version}`;
          } else {
            pillEl.style.display = 'none';
          }
        }

        metaLoaded = true;
      } catch {
        const target = document.getElementById('dashboard-version');
        target.textContent = 'Loading...';
        setTimeout(() => {
          if (!metaLoaded) loadMeta();
        }, 5000);
      }
    }

    function calculateBestModel(models) {
      const candidates = models.filter(m => m.status === 'up' && m.avg !== Infinity);
      if (candidates.length === 0) return null;

      return [...candidates].sort((a, b) => (b.qos || 0) - (a.qos || 0))[0];
    }

    function updateKPIs(models, bestModelId, pinnedModelId) {
      activePinnedModelId = pinnedModelId || null;
      const upModels = models.filter(m => m.status === 'up');

      const allProviders = new Set(models.map(m => m.providerKey));
      const onlineProviders = new Set();
      const now = Date.now();
      models.forEach(m => {
        if (m.status === 'up' && !m.isRateLimited) {
          if (m.lastPing !== 'TIMEOUT' || m.uptime > 0) {
            onlineProviders.add(m.providerKey);
          }
        }
      });

      document.getElementById('kpi-active').textContent = upModels.length;
      document.getElementById('kpi-providers').textContent = onlineProviders.size;

      drawModelsConstellation(models.length, upModels.length);
      drawProvidersNetwork(allProviders.size, onlineProviders.size);

      // Show the model the server is actually routing to
      const bestModel = bestModelId ? models.find(m => m.modelId === bestModelId) : null;
      document.getElementById('kpi-best').textContent = bestModel ? bestModel.label : 'None Online';

      drawCurrentModelAnimation(!!bestModel);

      // Show/hide pin badge
      const badge = document.getElementById('pin-badge');
      if (badge) badge.style.display = activePinnedModelId ? 'inline-block' : 'none';
    }

    function drawModelsConstellation(total, online) {
      const svg = document.getElementById('bg-models-svg');
      if (!svg) return;

      const numStars = Math.min(total, 100);
      const numBright = Math.min(online, numStars);

      if (svg.dataset.total != numStars || svg.children.length === 0) {
        svg.setAttribute('viewBox', '0 0 240 102');
        svg.innerHTML = '';
        svg.dataset.total = numStars;

        let seed = 42;
        const rand = () => { seed = (seed * 9301 + 49297) % 233280; return seed / 233280; };

        const points = [];
        for (let i = 0; i < numStars; i++) {
          points.push({ idx: i, x: 10 + rand() * 220, y: 10 + rand() * 82 });
        }

        for (let i = 0; i < points.length; i++) {
          let distances = points.map((p, idx) => ({ idx, d: Math.hypot(p.x - points[i].x, p.y - points[i].y) }));
          distances.sort((a, b) => a.d - b.d);
          for (let j = 1; j <= 2 && j < distances.length; j++) {
            if (distances[j].d < 60) {
              const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
              line.setAttribute('x1', points[i].x);
              line.setAttribute('y1', points[i].y);
              line.setAttribute('x2', points[distances[j].idx].x);
              line.setAttribute('y2', points[distances[j].idx].y);
              line.setAttribute('class', 'constellation-line-hidden');
              line.dataset.from = i;
              line.dataset.to = distances[j].idx;
              svg.appendChild(line);
            }
          }
        }

        points.forEach(p => {
          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('cx', p.x);
          circle.setAttribute('cy', p.y);
          circle.setAttribute('r', 1);
          circle.dataset.idx = p.idx;
          circle.setAttribute('class', 'star-dim');
          circle.style.animationDelay = `${rand() * 2}s`;
          svg.appendChild(circle);
        });
      }

      // Update classes gracefully based on online count
      const stars = Array.from(svg.querySelectorAll('circle'));
      const lines = Array.from(svg.querySelectorAll('line'));

      const brightIndices = new Set();
      stars.forEach(star => {
        const isBright = parseInt(star.dataset.idx) < numBright;
        if (isBright) brightIndices.add(parseInt(star.dataset.idx));

        const wasBright = star.classList.contains('star-bright');
        if (isBright !== wasBright) {
          star.setAttribute('class', isBright ? 'star-bright' : 'star-dim');
          star.setAttribute('r', isBright ? 1.5 : 1);
        }
      });

      lines.forEach(line => {
        const fromIdx = parseInt(line.dataset.from);
        const toIdx = parseInt(line.dataset.to);
        const shouldBeVisible = brightIndices.has(fromIdx) && brightIndices.has(toIdx);
        const isVisible = line.classList.contains('constellation-line');
        if (shouldBeVisible !== isVisible) {
          line.setAttribute('class', shouldBeVisible ? 'constellation-line' : 'constellation-line-hidden');
        }
      });
    }

    function drawProvidersNetwork(total, online) {
      const svg = document.getElementById('bg-providers-svg');
      if (!svg) return;

      const numNodes = Math.min(total, 50);
      const numOnline = Math.min(online, numNodes);

      if (svg.dataset.total != numNodes || svg.children.length === 0) {
        svg.setAttribute('viewBox', '0 0 240 102');
        svg.innerHTML = '';
        svg.dataset.total = numNodes;

        let seed = 123;
        const rand = () => { seed = (seed * 9301 + 49297) % 233280; return seed / 233280; };
        const hubX = 120, hubY = 90;

        for (let i = 0; i < numNodes; i++) {
          const x = 20 + rand() * 200;
          const y = 10 + rand() * 55;

          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', x);
          line.setAttribute('y1', y);
          line.setAttribute('x2', hubX);
          line.setAttribute('y2', hubY);
          line.setAttribute('class', 'net-link');
          line.dataset.idx = i;
          svg.appendChild(line);

          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('cx', x);
          circle.setAttribute('cy', y);
          circle.setAttribute('r', 2);
          circle.setAttribute('class', 'net-node-dim');
          circle.dataset.idx = i;
          circle.style.transformOrigin = `${x}px ${y}px`;
          circle.style.animationDelay = `${rand() * 2}s`;
          svg.appendChild(circle);
        }

        const hub = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        hub.setAttribute('cx', hubX);
        hub.setAttribute('cy', hubY);
        hub.setAttribute('r', 4);
        hub.setAttribute('class', 'net-hub');
        svg.appendChild(hub);
      }

      // Update element classes gracefully
      const nodes = Array.from(svg.querySelectorAll('circle:not(.net-hub)'));
      const links = Array.from(svg.querySelectorAll('line'));

      nodes.forEach(node => {
        const isOnline = parseInt(node.dataset.idx) < numOnline;
        if (isOnline !== node.classList.contains('net-node-bright')) {
          node.setAttribute('class', isOnline ? 'net-node-bright' : 'net-node-dim');
          node.setAttribute('r', isOnline ? 3 : 2);
        }
      });

      links.forEach(link => {
        const isOnline = parseInt(link.dataset.idx) < numOnline;
        if (isOnline !== link.classList.contains('net-link-active')) {
          link.setAttribute('class', isOnline ? 'net-link-active' : 'net-link');
        }
      });
    }

    function drawCurrentModelAnimation(hasActiveModel) {
      const svg = document.getElementById('bg-current-svg');
      if (!svg) return;
      if (svg.children.length === 0) {
        svg.setAttribute('viewBox', '0 0 240 102');

        const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        const pts = [];
        for (let i = 0; i < 6; i++) {
          const angle = (Math.PI / 3) * i;
          pts.push(`${120 + 40 * Math.cos(angle)},${50 + 40 * Math.sin(angle)}`);
        }
        poly.setAttribute('points', pts.join(' '));
        poly.setAttribute('class', 'current-core');
        poly.style.transformOrigin = '120px 50px';
        svg.appendChild(poly);

        const core = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        core.setAttribute('cx', 120);
        core.setAttribute('cy', 50);
        core.setAttribute('r', 16);
        core.setAttribute('class', 'current-pulse');
        svg.appendChild(core);
      }

      const elements = Array.from(svg.children);
      elements.forEach(el => {
        el.style.opacity = hasActiveModel ? '' : '0';
      });
    }

    async function pinModel(modelId) {
      try {
        await fetch('/api/pinned', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modelId: modelId || null })
        });
        await fetchData();
      } catch (e) {
        console.error('Failed to pin model', e);
      }
    }

    function toggleFilterBar() {
      const bar = document.querySelector('.filter-bar');
      bar.classList.toggle('visible');
    }

    function toggleAll(groupId) {
      const group = document.getElementById(groupId);
      const checkboxes = group.querySelectorAll('input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);

      checkboxes.forEach(cb => cb.checked = !allChecked);
      render(true);
    }

    function handleSearch() {
      searchTerm = document.getElementById('search-input').value.toLowerCase();
      render(true);
    }

    function setSort(col) {
      if (sortState && sortState.col === col) {
        if (sortState.dir === 'asc') {
          sortState = { col, dir: 'desc' };
        } else {
          // third click resets to default
          sortState = null;
        }
      } else {
        sortState = { col, dir: 'asc' };
      }
      updateSortHeaders();
      render(true);
    }

    function resetSort() {
      sortState = null;
      updateSortHeaders();
      render(true);
    }

    function updateSortHeaders() {
      const cols = ['model', 'qos', 'intell', 'ping', 'availability', 'status'];
      const resetBtn = document.getElementById('sort-reset-btn');
      cols.forEach(col => {
        const th = document.getElementById(`th-${col}`);
        const arrow = document.getElementById(`arrow-${col}`);
        th.classList.remove('sort-active');
        if (sortState && sortState.col === col) {
          th.classList.add('sort-active');
          arrow.textContent = sortState.dir === 'asc' ? '‚Üë' : '‚Üì';
        } else {
          arrow.textContent = '‚Üï';
        }
      });
      if (resetBtn) resetBtn.style.display = sortState ? 'inline-block' : 'none';
    }

    // Returns a comparable value for each column (lower = sorts first in asc)
    function colValue(m, col) {
      switch (col) {
        case 'status': return m.status === 'up' ? 0 : 1;
        case 'ping': return (m.avg === Infinity || m.avg === null) ? Infinity : m.avg;
        case 'availability': return m.uptime;
        case 'qos': return m.qos || 0;
        case 'intell': return getBenchmarkSortValue(m.intell);
        case 'rate': return m.isRateLimited ? 1 : 0;
        case 'health': return m.qos || 0; // fallback just in case
        case 'model': return (m.label || '').toLowerCase();
        default: return 0;
      }
    }

    // Default sort priority and direction when used as a tiebreaker.
    // dir: 1 = ascending (lower value first), -1 = descending (higher value first)
    const DEFAULT_SORT_CHAIN = [
      { col: 'status', dir: 1 },  // up (0) before down (1)
      { col: 'qos', dir: -1 },    // Highest QoS first
      { col: 'ping', dir: 1 },    // fallback tiebreaker
      { col: 'availability', dir: -1 }, // fallback tiebreaker
      { col: 'model', dir: 1 },   // alphabetical
    ];

    function compareByChain(a, b, chain) {
      for (const { col, dir } of chain) {
        const av = colValue(a, col);
        const bv = colValue(b, col);
        // Infinity always sorts last regardless of direction
        if (av === Infinity && bv === Infinity) continue;
        if (av === Infinity) return 1;
        if (bv === Infinity) return -1;
        const cmp = typeof av === 'string' ? av.localeCompare(bv) : (av - bv);
        if (cmp !== 0) return dir * cmp;
      }
      return 0;
    }

    function sortedModels(models) {
      const arr = [...models];
      if (!sortState) {
        return arr.sort((a, b) => compareByChain(a, b, DEFAULT_SORT_CHAIN));
      }

      const { col, dir } = sortState;
      const sign = dir === 'asc' ? 1 : -1;

      // Build chain: primary column first, then the remaining default columns as tiebreakers
      const tiebreakers = DEFAULT_SORT_CHAIN.filter(c => c.col !== col);

      return arr.sort((a, b) => {
        const av = colValue(a, col);
        const bv = colValue(b, col);
        // Ping: Infinity always last regardless of sort direction
        if (col === 'ping') {
          if (av === Infinity && bv === Infinity) return compareByChain(a, b, tiebreakers);
          if (av === Infinity) return 1;
          if (bv === Infinity) return -1;
        }
        const cmp = typeof av === 'string' ? av.localeCompare(bv) : (av - bv);
        if (cmp !== 0) return sign * cmp;
        return compareByChain(a, b, tiebreakers);
      });
    }

    function render(isUserAction = false) {
      if (!isUserAction && isTableHovered) return; // Pause updates if hovering over table
      const tbody = document.getElementById('table-body');

      // 1. Apply Search
      let filtered = allModels.filter(m =>
        m.label.toLowerCase().includes(searchTerm) ||
        m.providerKey.toLowerCase().includes(searchTerm) ||
        m.modelId.toLowerCase().includes(searchTerm)
      );

      // 2. Apply Checkbox Filters
      const getChecked = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(cb => cb.value);
      const allChecked = (id) => document.querySelectorAll(`#${id} input`).length === document.querySelectorAll(`#${id} input:checked`).length;

      const fProv = getChecked('filter-provider-group');
      const fPing = getChecked('filter-ping-group');
      const fAvail = getChecked('filter-avail-group');
      const fStatus = getChecked('filter-status-group');

      if (!allChecked('filter-provider-group')) filtered = filtered.filter(m => fProv.includes(m.providerKey));
      if (!allChecked('filter-status-group')) filtered = filtered.filter(m => fStatus.includes(m.status));

      if (!allChecked('filter-ping-group')) {
        filtered = filtered.filter(m => {
          const p = m.avg;
          if (p === Infinity || p === null) return false;
          if (fPing.includes('fast') && p < 400) return true;
          if (fPing.includes('medium') && p >= 400 && p < 1200) return true;
          if (fPing.includes('slow') && p >= 1200) return true;
          return false;
        });
      }

      if (!allChecked('filter-avail-group')) {
        filtered = filtered.filter(m => {
          const u = m.uptime;
          if (fAvail.includes('excellent') && u >= 95) return true;
          if (fAvail.includes('good') && u >= 85 && u < 95) return true;
          if (fAvail.includes('poor') && u < 85) return true;
          return false;
        });
      }

      const liveSortOn = document.getElementById('live-sort-toggle').checked;
      let sorted;

      // When the user acts OR liveSort is checked OR it's the first paint, sort properly:
      if (isUserAction || liveSortOn || currentRenderedOrder.length === 0) {
        sorted = sortedModels(filtered);
      } else {
        // Live sort is OFF: lock elements to their previously rendered positions,
        // but allow new data updates. New models fall to bottom.
        const orderMap = new Map(currentRenderedOrder.map((id, i) => [id, i]));
        sorted = [...filtered].sort((a, b) => {
          const idxA = orderMap.has(a.modelId) ? orderMap.get(a.modelId) : Infinity;
          const idxB = orderMap.has(b.modelId) ? orderMap.get(b.modelId) : Infinity;
          if (idxA !== Infinity && idxB !== Infinity) return idxA - idxB;
          if (idxA !== Infinity) return -1;
          if (idxB !== Infinity) return 1;
          return compareByChain(a, b, DEFAULT_SORT_CHAIN);
        });
      }

      const newOrderIds = sorted.map(m => m.modelId).join(',');
      const oldOrderIds = currentRenderedOrder.join(',');
      const currentRows = Array.from(tbody.rows);

      // We only recreate DOM nodes if length changed or the exact visual order shifted
      if (newOrderIds !== oldOrderIds || sorted.length !== currentRows.length) {
        tbody.innerHTML = '';
        sorted.forEach(m => tbody.appendChild(createRow(m)));
        currentRenderedOrder = sorted.map(m => m.modelId);
        return;
      }

      // Update existing rows
      sorted.forEach((m, i) => {
        const row = currentRows[i];
        const hasPing = m.avg !== Infinity && m.avg !== null;

        // Update pin button state in first cell
        const pinBtn = row.cells[0].querySelector('.pin-row-btn');
        if (pinBtn) {
          const isPinnedRow = m.modelId === activePinnedModelId;
          pinBtn.className = 'pin-row-btn' + (isPinnedRow ? ' pinned' : '');
          pinBtn.onclick = () => pinModel(isPinnedRow ? '' : m.modelId);
          pinBtn.title = isPinnedRow ? 'Unpin model' : 'Pin model';
        }

        // Update model name cell (ban status can change)
        const modelCell = row.cells[1];
        const isBannedRow = m.status === 'banned';
        modelCell.style.opacity = isBannedRow ? '0.5' : '1';
        modelCell.querySelector('div').firstChild.textContent = (isBannedRow ? 'üö´ ' : '') + m.label;
        modelCell.onclick = () => openDrawer(m);

        // Update QoS
        const qosCell = row.cells[2];
        qosCell.innerHTML = `<div style="font-weight: 700; color: ${getQosColor(m.qos)}">${getQosDisplayValue(m.qos)}</div>`;

        // Update Intell
        const intellCell = row.cells[3];
        intellCell.innerHTML = `<div style="font-weight: 600;">${getBenchmarkTableDisplayValue(m.intell)}</div>`;

        // Update status dot and text
        const statusCell = row.cells[6];
        statusCell.innerHTML = `
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="width: 6px; height: 6px; border-radius: 50%; background: ${m.status === 'up' ? 'var(--success)' : (m.status === 'disabled' || m.status === 'banned') ? 'var(--text-muted)' : 'var(--error)'}"></span>
              <span style="font-size: 0.75rem; font-weight: 500; text-transform: capitalize;">${m.status === 'noauth' ? 'No Auth' : m.status}</span>
            </div>
          `;

        // Update ping
        const pingCell = row.cells[4];
        const pingDot = pingCell.querySelector('.ping-dot');
        const pingTextEl = pingCell.querySelector('div[style*="text-align"]') || pingCell.querySelector('div:last-child');
        if (hasPing) {
          if (pingDot) {
            pingDot.className = 'ping-dot active ' + getPingAnimClass(m.avg);
            pingDot.style.setProperty('--speed', getPingSpeed(m.avg));
          }
          if (pingTextEl) pingTextEl.innerHTML = `<div style="font-size:0.82rem;">${m.avg}ms</div><div style="font-size:0.7rem; color:var(--text-muted);">(${m.lastPing}ms)</div>`;
        } else {
          if (pingDot) pingDot.className = 'ping-dot';
          if (pingTextEl) pingTextEl.innerHTML = '<span style="font-size: 0.75rem; color: var(--text-muted);">OFFLINE</span>';
        }

        // Update uptime and rate icon
        const uptimeCell = row.cells[5];
        const uptimeContainer = uptimeCell.querySelector('div');
        uptimeContainer.style.justifyContent = 'flex-end';
        uptimeContainer.querySelector('.progress-fill').style.width = m.uptime + '%';
        uptimeCell.querySelector('.progress-fill').style.background = m.uptime < 85 ? 'var(--warning)' : (m.uptime < 50 ? 'var(--error)' : 'var(--success)');
        uptimeCell.querySelector('.uptime-text').textContent = m.uptime + '%';

        const rateIcon = uptimeCell.querySelector('.rate-icon');
        if (rateIcon) {
          rateIcon.textContent = m.isRateLimited ? 'üïë' : '‚úÖ';
          rateIcon.title = m.isRateLimited ? 'Rate limit exceeded, waiting to reset' : 'Rate available';
          rateIcon.style.opacity = '1';
        }
      });
    }

    function createRow(m) {
      const tr = document.createElement('tr');
      const hasPing = m.avg !== Infinity && m.avg !== null;
      const pingClass = getPingAnimClass(m.avg);
      const pingSpeed = getPingSpeed(m.avg);

      const isPinnedRow = m.modelId === activePinnedModelId;
      tr.innerHTML = `
          <td>
            <div style="display:flex; flex-direction:column; gap:2px; align-items:center;">
              <div class="expand-btn" onclick='openDrawer(${JSON.stringify(m).replace(/'/g, "&apos;")})'>
                <svg width="12" height="12" viewBox="0 0 12 12"><path d="M6 2v8M2 6h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              </div>
              <div class="pin-row-btn ${isPinnedRow ? 'pinned' : ''}" onclick="pinModel('${isPinnedRow ? '' : m.modelId}')" title="${isPinnedRow ? 'Unpin model' : 'Pin model'}">üìå</div>
            </div>
          </td>
          <td style="opacity: ${m.status === 'banned' ? '0.5' : '1'}; cursor:pointer;" onclick='openDrawer(${JSON.stringify(m).replace(/'/g, "&apos;")})'>
            <div style="font-weight: 600;">${m.status === 'banned' ? 'üö´ ' : ''}${m.label}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted);">${m.providerKey}</div>
          </td>
          <td>
            <div style="font-weight: 700; color: ${getQosColor(m.qos)}">${getQosDisplayValue(m.qos)}</div>
          </td>
          <td><div style="font-weight: 600;">${getBenchmarkTableDisplayValue(m.intell)}</div></td>
          <td class="text-right">
            <div style="display: flex; align-items: center; gap: 8px; justify-content: flex-end;">
              <div class="ping-dot ${hasPing ? 'active ' + pingClass : ''}" style="--speed: ${pingSpeed}"></div>
              <div style="font-variant-numeric: tabular-nums; text-align:right; line-height:1.3;">
                ${hasPing
          ? `<div style="font-size:0.82rem;">${m.avg}ms</div><div style="font-size:0.7rem; color:var(--text-muted);">(${m.lastPing}ms)</div>`
          : '<span style="font-size: 0.75rem; color: var(--text-muted);">OFFLINE</span>'}
              </div>
            </div>
          </td>
          <td class="text-right">
            <div style="display: flex; align-items: center; gap: 12px; justify-content: flex-end;">
              <div class="progress-pill">
                <div class="progress-fill" style="width: ${m.uptime}%; background: ${m.uptime < 85 ? 'var(--warning)' : (m.uptime < 50 ? 'var(--error)' : 'var(--success)')}"></div>
              </div>
              <span class="uptime-text" style="font-size: 0.75rem; font-weight: 600;">${m.uptime}%</span>
              <span class="rate-icon" style="font-size:1.1rem; opacity: 1;" title="${m.isRateLimited ? 'Rate limit exceeded, waiting to reset' : 'Rate available'}">${m.isRateLimited ? 'üïë' : '‚úÖ'}</span>
            </div>
          </td>
          <td>
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="width: 6px; height: 6px; border-radius: 50%; background: ${m.status === 'up' ? 'var(--success)' : (m.status === 'disabled' || m.status === 'banned') ? 'var(--text-muted)' : 'var(--error)'}"></span>
              <span style="font-size: 0.75rem; font-weight: 500; text-transform: capitalize;">${m.status === 'noauth' ? 'No Auth' : m.status}</span>
            </div>
          </td>
        `;
      return tr;
    }

    function getPingAnimClass(ms) {
      if (ms === Infinity || ms === null) return '';
      if (ms < 400) return 'anim-fast';
      if (ms < 1200) return 'anim-medium';
      return 'anim-slow';
    }

    function getPingSpeed(ms) {
      if (ms === Infinity || ms === null) return '0s';
      if (ms < 400) return '3.5s';
      if (ms < 1200) return '2.5s';
      return '1.8s';
    }

    function getQosDisplayValue(qos) {
      const n = Number(qos);
      if (!Number.isFinite(n)) return 0;
      return Math.round(n);
    }

    function getQosColor(qos) {
      const n = Number(qos);
      if (!Number.isFinite(n)) return 'var(--error)';
      if (n >= 45) return '#16a34a';
      if (n >= 40) return '#4ade80';
      if (n >= 20) return 'var(--warning)';
      return 'var(--error)';
    }

    function getBenchmarkSortValue(value) {
      const n = Number(value);
      if (!Number.isFinite(n) || n <= 0) return 0;
      return n;
    }

    function getBenchmarkDisplayValue(value) {
      const n = Number(value);
      if (!Number.isFinite(n) || n <= 0) return '‚Äî';
      return Number(n.toFixed(1));
    }

    function getBenchmarkTableDisplayValue(value) {
      const n = Number(value);
      if (!Number.isFinite(n) || n <= 0) return '‚Äî';
      return Math.round(n * 100);
    }

    function formatIsoDateTime(value) {
      if (!value) return 'Never';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return 'Never';
      return d.toLocaleString();
    }

    function setAutoUpdateSaveStatus(message, tone = 'muted') {
      const statusEl = document.getElementById('autoupdate-save-status');
      if (!statusEl) return;
      statusEl.className = `autoupdate-save-status${tone === 'success' ? ' success' : tone === 'error' ? ' error' : ''}`;
      statusEl.textContent = message || '';
    }

    function applyAutoUpdateState(state) {
      if (!state) return;
      const enabled = state.enabled !== false;
      const stateText = enabled ? 'On' : 'Off';

      const stateEl = document.getElementById('autoupdate-state');
      if (stateEl) stateEl.textContent = stateText;

      const pillEl = document.getElementById('autoupdate-pill');
      if (pillEl) {
        pillEl.textContent = stateText;
        pillEl.classList.remove('on', 'off');
        pillEl.classList.add(enabled ? 'on' : 'off');
      }

      const enabledInput = document.getElementById('autoupdate-enabled');
      if (enabledInput) enabledInput.checked = enabled;

      const intervalInput = document.getElementById('autoupdate-interval');
      if (intervalInput && Number.isFinite(Number(state.intervalHours)) && Number(state.intervalHours) > 0) {
        intervalInput.value = String(Number(state.intervalHours));
      }

      const lastCheckEl = document.getElementById('autoupdate-last-check');
      if (lastCheckEl) lastCheckEl.textContent = formatIsoDateTime(state.lastCheckAt);

      const lastUpdateEl = document.getElementById('autoupdate-last-update');
      if (lastUpdateEl) lastUpdateEl.textContent = formatIsoDateTime(state.lastUpdateAt);

      const lastVersionEl = document.getElementById('autoupdate-last-version');
      if (lastVersionEl) lastVersionEl.textContent = state.lastVersionApplied || 'None';

      const lastErrorEl = document.getElementById('autoupdate-last-error');
      if (lastErrorEl) {
        const msg = state.lastError || 'None';
        lastErrorEl.textContent = msg;
        lastErrorEl.classList.toggle('error', !!state.lastError);
      }
    }

    async function saveAutoUpdateSettings() {
      const enabledEl = document.getElementById('autoupdate-enabled');
      const intervalEl = document.getElementById('autoupdate-interval');
      if (!enabledEl || !intervalEl) return;

      const intervalHours = Number(intervalEl.value);
      if (!Number.isFinite(intervalHours) || intervalHours <= 0) {
        setAutoUpdateSaveStatus('Interval must be a positive number of hours.', 'error');
        return;
      }

      setAutoUpdateSaveStatus('Saving...');

      try {
        const res = await fetch('/api/autoupdate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: enabledEl.checked, intervalHours })
        });

        if (!res.ok) {
          const payload = await res.json().catch(() => ({}));
          throw new Error(payload.error || 'Failed to save auto-update settings.');
        }

        const payload = await res.json();
        const state = payload.autoUpdate || null;
        if (state) applyAutoUpdateState(state);
        setAutoUpdateSaveStatus('Saved.', 'success');
      } catch (err) {
        setAutoUpdateSaveStatus(err.message || 'Failed to save auto-update settings.', 'error');
      }
    }

    function renderAutoUpdateSettings(autoUpdate) {
      const container = document.getElementById('autoupdate-container');
      if (!container || !autoUpdate) return;

      const enabled = autoUpdate.enabled !== false;
      const interval = Number(autoUpdate.intervalHours) > 0 ? Number(autoUpdate.intervalHours) : 24;
      const stateText = enabled ? 'On' : 'Off';

      container.innerHTML = `
        <div class="autoupdate-panel">
          <div class="autoupdate-header">
            <div>
              <h3 class="autoupdate-title">Auto-Update</h3>
              <div class="autoupdate-subtitle">Keep modelrelay fresh automatically with periodic npm checks and safe background restarts.</div>
            </div>
            <span id="autoupdate-pill" class="autoupdate-status-pill ${enabled ? 'on' : 'off'}">${stateText}</span>
          </div>

          <div class="autoupdate-controls">
            <label class="autoupdate-toggle-label">
            <input type="checkbox" id="autoupdate-enabled" ${enabled ? 'checked' : ''}>
            Enable auto-update
            </label>

            <label class="autoupdate-interval-label">
              Interval (hours)
              <input id="autoupdate-interval" type="number" min="1" step="1" value="${interval}">
            </label>

            <button class="btn" onclick="saveAutoUpdateSettings()">Save Changes</button>
            <span id="autoupdate-save-status" class="autoupdate-save-status"></span>
          </div>

          <div class="autoupdate-stats-grid">
            <div class="autoupdate-stat">
              <div class="autoupdate-stat-label">State</div>
              <div id="autoupdate-state" class="autoupdate-stat-value">${stateText}</div>
            </div>
            <div class="autoupdate-stat">
              <div class="autoupdate-stat-label">Last Check</div>
              <div id="autoupdate-last-check" class="autoupdate-stat-value">${formatIsoDateTime(autoUpdate.lastCheckAt)}</div>
            </div>
            <div class="autoupdate-stat">
              <div class="autoupdate-stat-label">Last Update</div>
              <div id="autoupdate-last-update" class="autoupdate-stat-value">${formatIsoDateTime(autoUpdate.lastUpdateAt)}</div>
            </div>
            <div class="autoupdate-stat">
              <div class="autoupdate-stat-label">Last Version</div>
              <div id="autoupdate-last-version" class="autoupdate-stat-value">${autoUpdate.lastVersionApplied || 'None'}</div>
            </div>
            <div class="autoupdate-stat" style="grid-column:1 / -1;">
              <div class="autoupdate-stat-label">Last Error</div>
              <div id="autoupdate-last-error" class="autoupdate-stat-value${autoUpdate.lastError ? ' error' : ''}">${escapeHtml(autoUpdate.lastError || 'None')}</div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadSettings() {
      try {
        const [providersRes, autoUpdateRes] = await Promise.all([
          fetch('/api/config'),
          fetch('/api/autoupdate'),
        ]);
        const providers = await providersRes.json();
        const autoUpdate = await autoUpdateRes.json();
        renderAutoUpdateSettings(autoUpdate);
        const container = document.getElementById('providers-container');
        container.innerHTML = '';

        providers.sort((a, b) => {
          if (a.hasKey && !b.hasKey) return -1;
          if (!a.hasKey && b.hasKey) return 1;
          return a.name.localeCompare(b.name);
        }).forEach(p => {
          const now = Date.now();
          const providerModels = allModels ? allModels.filter(m => m.providerKey === p.key) : [];
          // Count models for this provider from allModels
          const modelCount = providerModels.length;
          // Get rate limit info from a model with this provider that has rateLimit data
          const rlModel = providerModels.find(m => m.rateLimit) || null;
          const rl = rlModel?.rateLimit;
          const errorModel = providerModels
            .filter(m => {
              if (!m.lastError || m.status === 'up') return false;
              const updatedAtMs = Date.parse(m.lastError.updatedAt || '');
              return !Number.isNaN(updatedAtMs) && (now - updatedAtMs) <= PROVIDER_ERROR_MAX_AGE_MS;
            })
            .sort((a, b) => {
              const aTs = Date.parse(a.lastError.updatedAt || '');
              const bTs = Date.parse(b.lastError.updatedAt || '');
              if (Number.isNaN(aTs) && Number.isNaN(bTs)) return 0;
              if (Number.isNaN(aTs)) return 1;
              if (Number.isNaN(bTs)) return -1;
              return bTs - aTs;
            })[0] || null;
          const providerError = errorModel ? errorModel.lastError : null;

          const tokenOptional = p.supportsOptionalBearerAuth === true;
          const statusIcon = p.hasKey ? '‚úÖ' : (tokenOptional ? '‚ÑπÔ∏è' : '‚ö†Ô∏è');
          const statusColor = p.hasKey ? '#065f46' : (tokenOptional ? '#1e40af' : '#92400e');
          const statusBg = p.hasKey ? '#ecfdf5' : (tokenOptional ? '#eff6ff' : '#fffbeb');
          const statusText = p.hasKey
            ? (tokenOptional ? 'API Key configured' : 'Key configured')
            : (tokenOptional ? 'API Key optional' : 'No API key');

          let rateLimitHtml = '';
          if (rl) {
            const fmtNum = n => n >= 1000 ? (n / 1000).toFixed(0) + 'k' : String(n);
            const fmtTime = ts => {
              if (!ts) return null;
              const d = new Date(ts);
              return Number.isNaN(d.getTime()) ? null : d.toLocaleString();
            };
            const creditLine = rl.creditLimit != null
              ? `<span>Credits: <b>${fmtNum(rl.creditRemaining ?? '?')}</b> / ${fmtNum(rl.creditLimit)} remaining</span>`
              : '';
            const creditResetLine = rl.creditResetAt ? `<span>Credit reset: <b>${fmtTime(rl.creditResetAt) ?? 'unknown'}</b></span>` : '';
            rateLimitHtml = `
              <div style="margin-top:12px; padding:10px 12px; background:#f8fafc; border:1px solid var(--border); border-radius:8px; font-size:0.78rem;">
                <div style="font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:6px; font-size:0.7rem;">Rate Limits (last prompt)</div>
                <div style="display:flex; gap:16px; flex-wrap:wrap;">
                  ${rl.limitRequests != null ? `<span>Requests: <b>${fmtNum(rl.remainingRequests ?? '?')}</b> / ${fmtNum(rl.limitRequests)} remaining</span>` : ''}
                  ${rl.limitTokens != null ? `<span>Tokens: <b>${fmtNum(rl.remainingTokens ?? '?')}</b> / ${fmtNum(rl.limitTokens)} remaining</span>` : ''}
                  ${creditLine}
                  ${creditResetLine}
                </div>
              </div>`;
          }

          let providerErrorHtml = '';
          if (providerError && providerError.message) {
            const errorUpdated = providerError.updatedAt ? new Date(providerError.updatedAt) : null;
            const errorWhen = errorUpdated && !Number.isNaN(errorUpdated.getTime())
              ? errorUpdated.toLocaleString()
              : 'unknown time';
            providerErrorHtml = `
              <div style="margin-top:12px; padding:10px 12px; background:#fef2f2; border:1px solid #fecaca; border-radius:8px; font-size:0.78rem; color:#7f1d1d;">
                <div style="font-weight:600; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:6px; font-size:0.7rem; color:#991b1b;">Latest Provider Error</div>
                <div style="word-break:break-word;"><b>${escapeHtml(errorModel.modelId)}</b>: ${escapeHtml(providerError.message)}</div>
                <div style="margin-top:6px; color:#b91c1c;">HTTP ${escapeHtml(providerError.code || '?')} ‚Ä¢ ${escapeHtml(errorWhen)}</div>
              </div>`;
          }

          const qwenAuthActionsHtml = p.key === 'qwencode' ? `
            <div style="margin-top:10px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <button onclick="startQwenOAuthLogin()" style="border:1px solid var(--border); background:#fff; cursor:pointer; padding:8px 12px; border-radius:6px; font-size:0.78rem; font-weight:600;">Login with Qwen Code</button>
              <span id="qwencode-login-status" style="font-size:0.75rem; color:var(--text-muted);"></span>
            </div>
          ` : '';

          const optionalBearerAuthHtml = (tokenOptional && p.hasKey) ? `
            <div style="margin-top:10px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <label style="display:flex; align-items:center; gap:6px; font-size:0.8rem; cursor:pointer;">
                <input type="checkbox" id="bearer-auth-${p.key}" ${p.useBearerAuth !== false ? 'checked' : ''} onchange="updateProviderBearerAuth('${p.key}')">
                Attach API Key as Bearer
              </label>
            </div>
          ` : '';

          const section = document.createElement('div');
          section.className = 'provider-section';
          section.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem;">
              <div style="display:flex; align-items:center; gap:10px;">
                <span style="background:${statusBg}; color:${statusColor}; border-radius:999px; padding:2px 10px; font-size:0.75rem; font-weight:600;">${statusIcon} ${statusText}</span>
                <h3 style="margin:0; font-size:1rem;">${p.name}</h3>
                ${modelCount > 0 ? `<span style="background:#f3f2f1; color:var(--text-muted); border-radius:999px; padding:2px 8px; font-size:0.72rem; font-weight:600;">${modelCount} model${modelCount !== 1 ? 's' : ''}</span>` : ''}
                ${p.signupUrl ? `<a href="${p.signupUrl}" target="_blank" rel="noopener noreferrer" style="font-size:0.78rem; color:var(--accent); text-decoration:none; font-weight:600;">Get API key</a>` : ''}
              </div>
              <div style="display:flex; align-items:center; gap:10px;">
                <label style="display:flex; align-items:center; gap:6px; font-size:0.8rem; cursor:pointer;">
                  <input type="checkbox" id="enable-${p.key}" ${p.enabled ? 'checked' : ''} onchange="updateProvider('${p.key}')">
                  Enabled
                </label>
              </div>
            </div>
            <div class="form-group" style="display:flex; gap:8px; align-items:center;">
              <input type="password" id="key-${p.key}" placeholder="${p.hasKey ? '\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022 (' + (tokenOptional ? 'API Key Configured' : 'Key Configured') + ')' : (tokenOptional ? 'Enter API Key (optional)...' : 'Enter API Key...')}" style="flex:1;" onblur="updateProviderKey('${p.key}')">
              <button onclick="const i=document.getElementById('key-${p.key}'); i.type=i.type==='password'?'text':'password'; this.textContent=i.type==='password'?'üëÅ':'üôà';" style="border:1px solid var(--border); background:white; cursor:pointer; padding:8px 10px; border-radius:6px; font-size:0.85rem; white-space:nowrap;">üëÅ</button>
            </div>
            ${optionalBearerAuthHtml}
            ${qwenAuthActionsHtml}
            ${providerErrorHtml}
            ${rateLimitHtml}
          `;
          container.appendChild(section);
        });
      } catch (err) { console.error(err); }
    }

    async function updateProvider(key) {
      const enabled = document.getElementById(`enable-${key}`).checked;
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ providerKey: key, enabled })
      });
    }

    async function updateProviderKey(key) {
      const input = document.getElementById(`key-${key}`);
      const val = input.value.trim();
      if (!val) return;
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ providerKey: key, apiKey: val })
      });
      input.value = '';
      loadSettings();
    }

    async function updateProviderBearerAuth(key) {
      const input = document.getElementById(`bearer-auth-${key}`);
      if (!input) return;
      const useBearerAuth = input.checked;
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ providerKey: key, useBearerAuth })
      });
    }

    function setQwenLoginStatus(message, isError = false) {
      const statusEl = document.getElementById('qwencode-login-status');
      if (!statusEl) return;
      statusEl.style.color = isError ? 'var(--error)' : 'var(--text-muted)';
      statusEl.textContent = message || '';
    }

    async function pollQwenOAuthLoginStatus() {
      if (!qwenOauthSessionId) return;
      try {
        const res = await fetch(`/api/qwencode/login/status?sessionId=${encodeURIComponent(qwenOauthSessionId)}`);
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Failed to fetch Qwen OAuth login status.');
        }

        const data = await res.json();
        if (data.status === 'authorized') {
          setQwenLoginStatus('Qwen OAuth connected.');
          if (qwenOauthPollTimer) {
            clearInterval(qwenOauthPollTimer);
            qwenOauthPollTimer = null;
          }
          qwenOauthSessionId = null;
          loadSettings();
          fetchData();
          return;
        }

        if (data.status === 'error') {
          setQwenLoginStatus(data.error || 'Qwen OAuth login failed.', true);
          if (qwenOauthPollTimer) {
            clearInterval(qwenOauthPollTimer);
            qwenOauthPollTimer = null;
          }
          qwenOauthSessionId = null;
          return;
        }

        if (data.status === 'expired') {
          setQwenLoginStatus('Qwen login session expired. Click Login again.', true);
          if (qwenOauthPollTimer) {
            clearInterval(qwenOauthPollTimer);
            qwenOauthPollTimer = null;
          }
          qwenOauthSessionId = null;
          return;
        }

        setQwenLoginStatus('Waiting for Qwen authorization...');
      } catch (err) {
        setQwenLoginStatus(err.message || 'Failed to poll Qwen OAuth status.', true);
      }
    }

    async function startQwenOAuthLogin() {
      try {
        setQwenLoginStatus('Starting Qwen OAuth login...');
        const res = await fetch('/api/qwencode/login/start', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Failed to start Qwen OAuth login.');
        }

        qwenOauthSessionId = data.sessionId;
        if (data.verificationUriComplete) {
          window.open(data.verificationUriComplete, '_blank', 'noopener,noreferrer');
        }

        const codeSuffix = data.userCode ? ` (code: ${data.userCode})` : '';
        setQwenLoginStatus(`Complete login in browser${codeSuffix}`);

        if (qwenOauthPollTimer) clearInterval(qwenOauthPollTimer);
        const pollMs = Number(data.pollIntervalMs) > 0 ? Number(data.pollIntervalMs) : 2000;
        qwenOauthPollTimer = setInterval(pollQwenOAuthLoginStatus, pollMs);
        pollQwenOAuthLoginStatus();
      } catch (err) {
        setQwenLoginStatus(err.message || 'Failed to start Qwen OAuth login.', true);
      }
    }

    async function loadLogs() {
      try {
        const res = await fetch('/api/logs');
        const logs = await res.json();
        const container = document.getElementById('logs-container');

        if (logs.length === 0) {
          container.innerHTML = '<div style="padding: 32px; text-align: center; color: var(--text-muted); background: var(--card); border: 1px solid var(--border); border-radius: 12px;">No requests have been routed yet.</div>';
          return;
        }

        if (logsViewMode === 'history') {
          renderMessageHistory(logs, container);
          return;
        }

        const expandedCards = new Set();
        document.querySelectorAll('.log-card.expanded').forEach(card => {
          expandedCards.add(card.id);
        });

        container.innerHTML = logs.map(l => {
          const date = new Date(l.timestamp);
          const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          const attempts = Array.isArray(l.attempts) ? l.attempts : [];
          const retryCount = typeof l.retryCount === 'number'
            ? l.retryCount
            : Math.max(0, attempts.length - 1);
          const hadFailover = retryCount > 0;
          let statusBadge = '';
          if (l.status === '200') statusBadge = '<span style="background: #ecfdf5; color: #065f46; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">200 OK</span>';
          else if (l.status === 'pending') statusBadge = '<span style="background: #eff6ff; color: #1e40af; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">Pending...</span>';
          else statusBadge = `<span style="background: #fef2f2; color: #991b1b; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">${l.status}</span>`;
          const resolvedModelChip = l.resolvedModel
            ? `<span style="background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:0.7rem; font-weight:700;">resolved: ${escapeHtml(l.resolvedModel)}</span>`
            : '';

          let messagesArray = Array.isArray(l.messages) ? l.messages : (typeof l.messages === 'string' ? [{ role: 'raw', content: l.messages }] : []);
          const msgHtml = messagesArray.map(m => {
            const isSystem = m.role === 'system';
            const isUser = m.role === 'user';
            const colorVar = isSystem ? 'var(--warning)' : (isUser ? 'var(--success)' : 'var(--accent)');
            let formattedContent = typeof m.content === 'string' ? m.content : JSON.stringify(m.content, null, 2);
            // Replace brackets with HTML entities to prevent rendering issues
            formattedContent = (formattedContent || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            return `
              <div style="margin-top: 12px; border-left: 3px solid ${colorVar}; padding-left: 12px;">
                <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${colorVar}; margin-bottom: 4px;">${m.role}</div>
                <div style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; color: var(--text); max-height: 200px; overflow-y: auto; background: #faf9f8; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">${formattedContent}</div>
              </div>
            `;
          }).join('');

          let responseHtml = '';
          if (l.response) {
            let formattedResp = l.response.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            responseHtml = `
              <div style="margin-top: 12px; border-left: 3px solid var(--accent); padding-left: 12px;">
                <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent); margin-bottom: 4px;">ASSISTANT</div>
                <div style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; color: var(--text); max-height: 300px; overflow-y: auto; background: #faf9f8; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">${formattedResp}</div>
              </div>
            `;
          }

          let toolCallsHtml = '';
          if (l.tool_calls && l.tool_calls.length > 0) {
            const numTools = l.tool_calls.length;
            const tcStr = JSON.stringify(l.tool_calls, null, 2).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            toolCallsHtml = `
              <div style="margin-top: 12px; border-left: 3px solid var(--accent); padding-left: 12px;">
                <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent); margin-bottom: 4px;">TOOL CALLS (${numTools})</div>
                <div style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; color: var(--text); max-height: 200px; overflow-y: auto; background: #faf9f8; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">${tcStr}</div>
              </div>
            `;
          }

          let functionCallHtml = '';
          if (l.function_call) {
            const fcStr = JSON.stringify(l.function_call, null, 2).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            functionCallHtml = `
              <div style="margin-top: 12px; border-left: 3px solid var(--accent); padding-left: 12px;">
                <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent); margin-bottom: 4px;">FUNCTION CALL</div>
                <div style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; color: var(--text); max-height: 200px; overflow-y: auto; background: #faf9f8; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">${fcStr}</div>
              </div>
            `;
          }

          let errorHtml = '';
          if (l.error) {
            let formattedErr = typeof l.error === 'string' ? l.error : JSON.stringify(l.error, null, 2);
            formattedErr = formattedErr.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            errorHtml = `
              <div style="margin-top: 12px; border-left: 3px solid var(--error); padding-left: 12px;">
                <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--error); margin-bottom: 4px;">PROXY ERROR</div>
                <div style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; color: #7f1d1d; max-height: 200px; overflow-y: auto; background: #fef2f2; padding: 8px; border-radius: 6px; border: 1px solid #fecaca;">${formattedErr}</div>
              </div>
            `;
          }

          let failoverHtml = '';
          if (attempts.length > 0) {
            const attemptRows = attempts.map((a, idx) => {
              const code = a && a.status ? String(a.status) : 'unknown';
              const isOk = code === '200';
              const isRetryable = !!(a && a.retryable);
              const chipBg = isOk ? '#ecfdf5' : (isRetryable ? '#fffbeb' : '#fef2f2');
              const chipFg = isOk ? '#065f46' : (isRetryable ? '#92400e' : '#991b1b');
              const model = a && a.model ? a.model : '(unknown model)';
              const provider = a && a.provider ? a.provider : '(unknown provider)';
              const duration = a && a.duration != null ? `${a.duration}ms` : 'n/a';
              const err = a && a.error
                ? `<div style="margin-top:4px; color: var(--text-muted); font-size:0.72rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${String(a.error).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`
                : '';
              return `
                <div style="padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; background: #faf9f8;">
                  <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                    <div style="font-size:0.78rem; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"><span style="color:var(--text-muted);">#${idx + 1}</span> ${provider}/${model}</div>
                    <div style="display:flex; align-items:center; gap:6px; flex-shrink:0;">
                      <span style="font-size:0.7rem; color:var(--text-muted);">${duration}</span>
                      <span style="background:${chipBg}; color:${chipFg}; padding:2px 6px; border-radius:999px; font-size:0.68rem; font-weight:700;">${code}</span>
                    </div>
                  </div>
                  ${err}
                </div>`;
            }).join('');

            failoverHtml = `
              <div style="margin-top: 12px; border-left: 3px solid ${hadFailover ? 'var(--warning)' : 'var(--accent)'}; padding-left: 12px;">
                <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${hadFailover ? 'var(--warning)' : 'var(--accent)'}; margin-bottom: 6px;">ROUTING ATTEMPTS ${hadFailover ? `(Failovers: ${retryCount})` : ''}</div>
                <div style="display:flex; flex-direction:column; gap:6px;">${attemptRows}</div>
              </div>
            `;
          }

          const logModelStatus = allModels ? (allModels.find(m => m.modelId === l.model)?.status || 'unknown') : 'unknown';
          const isBanned = logModelStatus === 'banned';
          // Use a stable unique id for toggling
          const cardId = 'log-' + l.timestamp.replace(/[^a-z0-9]/gi, '');
          const isExpanded = expandedCards.has(cardId) ? ' expanded' : '';
          return `
            <div class="log-card${isExpanded}" id="${cardId}">
              <div class="log-card-header" onclick="toggleLogCard('${cardId}')">
                <div style="display:flex; align-items:center; gap:10px; min-width:0; flex:1;">
                  <span class="log-chevron">‚ñ∂</span>
                  <div style="min-width:0;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap:wrap;">
                      <span style="font-weight: 600; font-size: 0.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${l.model}</span>
                      ${resolvedModelChip}
                      ${statusBadge}
                    </div>
                    <div style="font-size: 0.78rem; color: var(--text-muted); display: flex; gap: 10px; flex-wrap: wrap; margin-top:2px;">
                      <span>${timeStr}</span>
                      <span>‚Ä¢</span>
                      <span>${l.provider}</span>
                      ${hadFailover ? `<span>‚Ä¢</span><span style="color: var(--warning); font-weight: 600;">üîÅ ${retryCount} failover${retryCount > 1 ? 's' : ''}</span>` : ''}
                      ${l.duration ? `<span>‚Ä¢</span><span>${l.duration}ms total</span>` : ''}
                      ${l.ttft != null && l.ttft !== l.duration ? `<span>‚Ä¢</span><span style="color: var(--accent);">‚ö° ${l.ttft}ms TTFT</span>` : ''}
                      ${l.prompt_tokens != null || l.completion_tokens != null ? `<span>‚Ä¢</span><span style="color: var(--text-muted);"><span style="font-weight: 600; color: var(--text);">${l.prompt_tokens || 0}</span> in / <span style="font-weight: 600; color: var(--text);">${l.completion_tokens || 0}</span> out</span>` : ''}
                    </div>
                  </div>
                </div>
              </div>
              <div class="log-card-body">
                ${msgHtml}
                ${responseHtml}
                ${toolCallsHtml}
                ${functionCallHtml}
                ${failoverHtml}
                ${errorHtml}
                <div style="margin-top:16px; padding-top:12px; border-top:1px solid var(--border); display:flex; justify-content:flex-end;">
                  <button onclick="event.stopPropagation(); toggleBan('${l.model}', '${logModelStatus}')" style="background: ${isBanned ? '#e5e7eb' : '#fef2f2'}; border: 1px solid ${isBanned ? '#d1d5db' : '#fecaca'}; padding: 6px 14px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; color: ${isBanned ? '#374151' : '#991b1b'}; cursor: pointer;">${isBanned ? '‚úì Unban Model' : 'üö´ Ban Model'}</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) { console.error(err); }
    }

    function setLogsViewMode(mode) {
      logsViewMode = mode === 'history' ? 'history' : 'cards';
      const cardsBtn = document.getElementById('logs-mode-cards');
      const historyBtn = document.getElementById('logs-mode-history');
      if (cardsBtn && historyBtn) {
        cardsBtn.classList.toggle('active', logsViewMode === 'cards');
        historyBtn.classList.toggle('active', logsViewMode === 'history');
        cardsBtn.setAttribute('aria-selected', logsViewMode === 'cards' ? 'true' : 'false');
        historyBtn.setAttribute('aria-selected', logsViewMode === 'history' ? 'true' : 'false');
      }
      loadLogs();
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function stableStringify(value) {
      if (value == null || typeof value !== 'object') {
        return JSON.stringify(value);
      }
      if (Array.isArray(value)) {
        return '[' + value.map(stableStringify).join(',') + ']';
      }
      const keys = Object.keys(value).sort();
      return '{' + keys.map(k => JSON.stringify(k) + ':' + stableStringify(value[k])).join(',') + '}';
    }

    function getLocalDayKey(ts) {
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return 'invalid-day';
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function simpleHash(input) {
      let hash = 2166136261;
      for (let i = 0; i < input.length; i++) {
        hash ^= input.charCodeAt(i);
        hash = Math.imul(hash, 16777619);
      }
      return (hash >>> 0).toString(16);
    }

    function normalizeMessageForHash(msg) {
      const normalized = {
        role: msg && msg.role ? String(msg.role) : 'unknown',
        name: msg && msg.name ? String(msg.name) : '',
        tool_call_id: msg && msg.tool_call_id ? String(msg.tool_call_id) : '',
        content: msg && msg.content != null ? msg.content : '',
      };
      if (msg && msg.tool_calls != null) normalized.tool_calls = msg.tool_calls;
      if (msg && msg.function_call != null) normalized.function_call = msg.function_call;
      return stableStringify(normalized);
    }

    function formatMessageContent(content) {
      if (typeof content === 'string') return content;
      if (content == null) return '';
      try {
        return JSON.stringify(content, null, 2);
      } catch {
        return String(content);
      }
    }

    function roleColor(role) {
      if (role === 'system') return 'var(--warning)';
      if (role === 'user') return 'var(--success)';
      if (role === 'assistant') return 'var(--accent)';
      if (role === 'tool') return '#8b5cf6';
      return 'var(--text-muted)';
    }

    function renderMessageHistory(logs, container) {
      const deduped = [];
      const seen = new Set();
      let insertSeq = 0;

      const mostRecentFirst = Array.isArray(logs) ? logs : [];
      for (const l of mostRecentFirst) {
        const timestamp = l && l.timestamp ? l.timestamp : null;
        const model = l && l.model ? l.model : '(unknown model)';
        const resolvedModel = l && l.resolvedModel ? l.resolvedModel : null;
        const sourceMessages = Array.isArray(l && l.messages)
          ? [...l.messages].reverse()
          : (typeof (l && l.messages) === 'string' ? [{ role: 'raw', content: l.messages }] : []);

        if (l && l.response) {
          const assistantCandidate = { role: 'assistant', content: l.response };
          const dedupeKey = `${getLocalDayKey(timestamp)}:${simpleHash(normalizeMessageForHash(assistantCandidate))}`;
          if (!seen.has(dedupeKey)) {
            seen.add(dedupeKey);
            deduped.push({ role: 'assistant', content: l.response, timestamp, model, resolvedModel, tsMs: Date.parse(timestamp || ''), seq: insertSeq++ });
          }
        }

        if (l && l.tool_calls) {
          const toolCallsCandidate = { role: 'assistant', content: l.tool_calls };
          const dedupeKey = `${getLocalDayKey(timestamp)}:${simpleHash(normalizeMessageForHash(toolCallsCandidate))}`;
          if (!seen.has(dedupeKey)) {
            seen.add(dedupeKey);
            deduped.push({ role: 'assistant', content: l.tool_calls, timestamp, model, resolvedModel, tsMs: Date.parse(timestamp || ''), seq: insertSeq++ });
          }
        }

        if (l && l.function_call) {
          const functionCallCandidate = { role: 'assistant', content: l.function_call };
          const dedupeKey = `${getLocalDayKey(timestamp)}:${simpleHash(normalizeMessageForHash(functionCallCandidate))}`;
          if (!seen.has(dedupeKey)) {
            seen.add(dedupeKey);
            deduped.push({ role: 'assistant', content: l.function_call, timestamp, model, resolvedModel, tsMs: Date.parse(timestamp || ''), seq: insertSeq++ });
          }
        }

        for (const m of sourceMessages) {
          const role = m && m.role ? String(m.role) : 'unknown';
          const content = m && m.content != null ? m.content : '';
          const candidate = {
            role,
            content,
            name: m && m.name ? m.name : '',
            tool_call_id: m && m.tool_call_id ? m.tool_call_id : '',
            tool_calls: m && m.tool_calls ? m.tool_calls : undefined,
            function_call: m && m.function_call ? m.function_call : undefined,
          };
          const dedupeKey = `${getLocalDayKey(timestamp)}:${simpleHash(normalizeMessageForHash(candidate))}`;
          if (seen.has(dedupeKey)) continue;
          seen.add(dedupeKey);
          deduped.push({ role, content, timestamp, model, resolvedModel, tsMs: Date.parse(timestamp || ''), seq: insertSeq++ });
        }
      }

      deduped.sort((a, b) => {
        const aTs = Number.isNaN(a.tsMs) ? -Infinity : a.tsMs;
        const bTs = Number.isNaN(b.tsMs) ? -Infinity : b.tsMs;
        if (bTs !== aTs) return bTs - aTs;
        return a.seq - b.seq;
      });

      if (deduped.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align:center; color:var(--text-muted); background: var(--card); border: 1px solid var(--border); border-radius: 12px;">No messages found in recent request logs.</div>';
        return;
      }

      container.innerHTML = deduped.map(item => {
        const role = item.role || 'unknown';
        const date = new Date(item.timestamp);
        const timeStr = Number.isNaN(date.getTime())
          ? 'Unknown time'
          : date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const dateStr = Number.isNaN(date.getTime())
          ? 'Unknown date'
          : date.toLocaleDateString([], { year: 'numeric', month: 'short', day: '2-digit' });
        const content = escapeHtml(formatMessageContent(item.content));
        const badgeColor = roleColor(role);

        return `
          <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <span style="font-size: 0.68rem; font-weight:700; letter-spacing:0.06em; text-transform:uppercase; color:${badgeColor};">${escapeHtml(role)}</span>
            </div>
            <div style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; color: var(--text); background: #faf9f8; padding: 9px; border-radius: 7px; border: 1px solid var(--border); max-height: 240px; overflow-y:auto;">${content}</div>
            <div style="margin-top:8px; font-size: 0.74rem; color: var(--text-muted); display:flex; gap:8px; flex-wrap:wrap;">
              <span>${timeStr}</span>
              <span>‚Ä¢</span>
              <span>${dateStr}</span>
              <span>‚Ä¢</span>
              <span>${escapeHtml(item.model || '(unknown model)')}</span>
              ${item.resolvedModel ? `<span>‚Ä¢</span><span style="color:#3730a3;">resolved: ${escapeHtml(item.resolvedModel)}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleLogCard(id) {
      document.getElementById(id)?.classList.toggle('expanded');
    }

    function openDrawer(m) {
      openDrawerModelId = m.modelId;
      document.getElementById('drawer-title').textContent = m.label;
      updateDrawerContent(m);
      document.getElementById('drawer').classList.add('open');
      document.getElementById('overlay').classList.add('active');
    }

    function updateDrawerContent(m) {
      // Build real telemetry chart from ping history
      const pings = m.pings || [];
      const successPings = pings.filter(p => p.code === '200' && typeof p.ms === 'number');
      const maxMs = successPings.length > 0 ? Math.max(...successPings.map(p => p.ms)) : 0;
      const minMs = successPings.length > 0 ? Math.min(...successPings.map(p => p.ms)) : 0;

      let chartHtml;
      if (pings.length === 0) {
        chartHtml = `<div style="height:48px; display:flex; align-items:center; justify-content:center; color:var(--text-muted); font-size:0.8rem;">No data yet ‚Äî collecting pings...</div>`;
      } else {
        const bars = pings.map(p => {
          const ok = p.code === '200' && typeof p.ms === 'number';
          const heightPct = ok && maxMs > 0
            ? Math.max(15, Math.round((p.ms / maxMs) * 100))
            : 15;
          const color = ok ? 'var(--success)' : 'var(--error)';
          const tip = ok ? `${p.ms}ms` : (p.code === '000' ? 'timeout' : `HTTP ${p.code}`);
          return `<div title="${tip}" style="flex:1; min-width:4px; height:${heightPct}%; background:${color}; border-radius:2px; opacity:0.8; cursor:default;"></div>`;
        }).join('');

        const rangeLabel = successPings.length > 0
          ? `${minMs}ms ‚Äì ${maxMs}ms &nbsp;¬∑&nbsp; ${successPings.length}/${pings.length} ok`
          : `${pings.length} ping${pings.length > 1 ? 's' : ''}, none successful`;

        chartHtml = `
          <div style="display:flex; gap:2px; height:48px; align-items:flex-end;">${bars}</div>
          <div style="margin-top:8px; font-size:0.72rem; color:var(--text-muted); display:flex; justify-content:space-between;">
            <span>${rangeLabel}</span>
            <span style="display:flex; gap:10px; align-items:center;">
              <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:var(--success);"></span>ok</span>
              <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:var(--error);"></span>fail</span>
            </span>
          </div>`;
      }

      const isModelPinned = m.modelId === activePinnedModelId;
      const lastErrorHtml = m.lastError && m.lastError.message
        ? `<div style="margin: -6px 0 14px; padding: 10px 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #7f1d1d; font-size: 0.76rem;">
            <div style="font-weight: 700; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.68rem; color: #991b1b;">Last Ping Error</div>
            <div style="word-break: break-word;">${escapeHtml(m.lastError.message)}</div>
          </div>`
        : '';
      document.getElementById('drawer-content').innerHTML = `
        <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
          <div style="min-width:0; flex:1;">
            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Model ID</div>
            <div style="font-family: monospace; background: #f3f2f1; padding: 12px; border-radius: 8px; font-size: 0.875rem; word-break:break-all;">${m.modelId}</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; flex-shrink:0;">
            <button onclick="pinModel('${isModelPinned ? '' : m.modelId}')" style="background: ${isModelPinned ? '#eff6ff' : '#f3f2f1'}; border: ${isModelPinned ? '1px solid #bfdbfe' : '1px solid transparent'}; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; color: ${isModelPinned ? '#1e40af' : 'var(--text)'}; cursor: pointer;">
              ${isModelPinned ? 'üìå Unpin Model' : 'üìå Pin Model'}
            </button>
            <button onclick="pingModelNow('${m.modelId}')" style="background: #ecfeff; border: 1px solid #a5f3fc; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; color: #0e7490; cursor: pointer;">
              üì∂ Ping Now
            </button>
            <button onclick="toggleBan('${m.modelId}', '${m.status}')" style="background: ${m.status === 'banned' ? 'var(--text-muted)' : '#fef2f2'}; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; color: ${m.status === 'banned' ? '#fff' : '#991b1b'}; cursor: pointer;">
              ${m.status === 'banned' ? 'Unban Model' : 'Ban Model'}
            </button>
          </div>
        </div>
        ${lastErrorHtml}
        <div id="drawer-ping-status" style="margin: -8px 0 16px; font-size: 0.75rem; color: var(--text-muted);"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
          <div style="background: #faf9f8; padding: 16px; border-radius: 12px; border: 1px solid var(--border);">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">SWE-bench</div>
            <div style="font-weight: 700;">${getBenchmarkDisplayValue(m.intell)}</div>
          </div>
          <div style="background: #faf9f8; padding: 16px; border-radius: 12px; border: 1px solid var(--border);">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Context</div>
            <div style="font-weight: 700;">${m.ctx || 'N/A'}</div>
          </div>
        </div>
        <div style="margin-top: auto; padding-top: 40px;">
          <h4 style="margin-bottom: 12px; font-size: 0.875rem;">Recent Telemetry <span style="font-weight:400; color:var(--text-muted);">(last ${pings.length} ping${pings.length !== 1 ? 's' : ''})</span></h4>
          ${chartHtml}
        </div>
      `;
    }

    function closeDrawer() {
      openDrawerModelId = null;
      document.getElementById('drawer').classList.remove('open');
      document.getElementById('overlay').classList.remove('active');
    }

    async function pingModelNow(modelId) {
      const statusEl = document.getElementById('drawer-ping-status');
      if (statusEl) {
        statusEl.style.color = 'var(--text-muted)';
        statusEl.textContent = 'Pinging model now...';
      }

      try {
        const res = await fetch('/api/models/ping', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modelId })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
          throw new Error(data.error || 'Failed to ping model.');
        }

        if (statusEl) {
          const last = data.model && data.model.lastPing != null ? `${data.model.lastPing}ms` : 'done';
          statusEl.style.color = 'var(--success)';
          statusEl.textContent = `Ping complete (${last}).`;
        }

        await fetchData();

        if (openDrawerModelId === modelId) {
          const updatedModel = allModels ? allModels.find(r => r.modelId === modelId) : null;
          if (updatedModel) updateDrawerContent(updatedModel);
        }
      } catch (e) {
        if (statusEl) {
          statusEl.style.color = 'var(--error)';
          statusEl.textContent = e.message || 'Failed to ping model.';
        }
      }
    }

    async function toggleBan(modelId, currentStatus) {
      try {
        const isBanning = currentStatus !== 'banned';
        await fetch('/api/models/ban', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modelId, banned: isBanning })
        });

        // Immediately refresh telemetry data and logs
        await fetchData();
        if (typeof loadLogs === 'function') loadLogs();

        // Re-render drawer if it is currently open for this model
        if (openDrawerModelId === modelId) {
          const updatedModel = allModels ? allModels.find(r => r.modelId === modelId) : null;
          if (updatedModel) updateDrawerContent(updatedModel);
        }
      } catch (e) {
        console.error('Failed to toggle ban status', e);
      }
    }

    setInterval(fetchData, 4000);
    fetchData();
  </script>
</body>

</html>
